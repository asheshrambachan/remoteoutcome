% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/rsv_estimator.R
\name{rsv_estimate}
\alias{rsv_estimate}
\title{RSV Treatment Effect Estimator}
\usage{
rsv_estimate(
  Y = NULL,
  D = NULL,
  S_e = NULL,
  S_o = NULL,
  R = NULL,
  pred_Y = NULL,
  pred_D = NULL,
  pred_S_e = NULL,
  pred_S_o = NULL,
  theta_init = NULL,
  eps = 0.01,
  method = c("crossfit", "split", "none", "predictions"),
  ml_params = list(),
  se = TRUE,
  se_params = list(),
  cores = 1
)
}
\arguments{
\item{Y}{Outcome variable (binary, \code{NA} where not observed).}

\item{D}{Treatment indicator (binary, \code{NA} where not observed).}

\item{S_e}{Experimental sample indicator (0 or 1).}

\item{S_o}{Observational sample indicator (0 or 1).}

\item{R}{Remotely sensed variable. Required if predictions are not provided.}

\item{pred_Y}{(Optional) Predicted \eqn{P(Y \mid R, S_o = 1)}, \eqn{\text{PRED}_Y(R)}. If provided, other predictions must also be provided.}

\item{pred_D}{(Optional) Predicted \eqn{P(D \mid R, S_e = 1)}, \eqn{\text{PRED}_D(R)}.}

\item{pred_S_e}{(Optional) Predicted \eqn{P(S_e = 1 \mid R)}, \eqn{\text{PRED}_{S_e}(R)}.}

\item{pred_S_o}{(Optional) Predicted \eqn{P(S_o = 1 \mid R)}, \eqn{\text{PRED}_{S_o}(R)}.}

\item{theta_init}{Initial estimate of the treatment effect on the train data.}

\item{eps}{Small constant for numerical stability of \code{sigma2} estimate (default \code{1e-2}).}

\item{method}{Prediction fitting method; one of \code{"split"} (default), \code{"crossfit"}, or \code{"none"}.
\code{"split"} = simple sample split; \code{"crossfit"} = K-fold cross-fitting; \code{"none"} = use all data for training/testing.}

\item{ml_params}{List of parameters for random forest:
\describe{
  \item{ntree}{Number of trees}
  \item{classwt_Y}{Class weights for \code{pred_Y} model; default \code{c(10, 1)})}
  \item{seed}{User specified seed passed to each \code{ranger} function for reproducibility; default \code{NULL}}
  \item{nfolds}{Number of folds for cross-fitting (default \code{5}).}
  \item{train_ratio}{Proportion for training in sample split (default \code{0.5}).}
}}

\item{se}{Logical; compute standard errors via bootstrap? (default \code{TRUE}).}

\item{se_params}{List of bootstrap parameters:
\describe{
  \item{B}{Number of bootstrap replications (default \code{1000})}
  \item{fix_seed}{If \code{TRUE}, deterministic seeding is used with `set.seed(b)` for the *b*â€‘th replication (default \code{FALSE})}
  \item{clusters}{Clusters for the bootstrap. If \code{NULL}, uses individual-level bootstrap}
}}

\item{cores}{Number of cores used by either `ranger` or bootstrap replications; default \code{1}}
}
\value{
A list of class \code{"rsv"} with components:
\describe{
  \item{coef}{Treatment effect estimate.}
  \item{se}{Standard error (if \code{se = TRUE}).}
  \item{denominator_se}{Standard error of the denominator of the treatment effect (if \code{se = TRUE})}
  \item{n_obs}{Sample size in observational sample.}
  \item{n_exp}{Sample size in experimental sample.}
  \item{n_both}{Sample size in both samples.}
  \item{numerator}{Numerator of the treatment effect estimate}
  \item{denominator}{Denominator of the treatment effect estimate}
  \item{method}{Prediction fitting method used.}
  \item{call}{The matched call.}
}
}
\description{
Estimates treatment effects using remotely sensed variables (RSVs) following
Rambachan, Singh, and Viviano (2025). Implements Algorithm 1 from the main
text for binary outcomes without pretreatment covariates.
}
\details{
The function supports two interfaces:
\enumerate{
  \item Provide fitted predictions \code{pred_Y}, \code{pred_D}, \code{pred_S_e}, \code{pred_S_o} directly.
  \item Provide raw data \code{(Y, D, S, R)} and the function fits predictions using random forests.
}

The function also supports sample splitting and K-fold cross-fitting for
prediction fitting.
}
\examples{
\dontrun{
library(dplyr)
library(remoteoutcome)

# Load the data
data("smartcard_data_p1", package="remoteoutcome")
data("smartcard_data_p2", package="remoteoutcome")

# Merge to create complete dataset
smartcard_data <- inner_join(smartcard_data_p1, smartcard_data_p2, by="shrid2")
rm(smartcard_data_p1, smartcard_data_p2)

data_real <- create_data_real(smartcard_data)

Y <- data_real$Ycons # binary outcome
D <- data_real$D # binary treatment
R <- data_real \%>\% select(
   starts_with("luminosity"), 
   starts_with("satellite")
) # remotely sensed variable
S_e <- !is.na(D) & (rowSums(is.na(R)) == 0) # experimental sample indicator (Observe D, R)
S_o <- !is.na(Y) & (rowSums(is.na(R)) == 0) #  observational sample indicator (Observe Y, R)
clusters <- data_real$clusters # Subdistrict-level cluster identifiers

# Example 1: No sample splitting
result <- rsv_estimate(
   Y = Y, D = D, S_e = S_e, S_o = S_o, R = R,
   method = "none",
   ml_params = list(seed = 42),
   se_params = list(fix_seed = TRUE, clusters = clusters),
   cores = 7
)
print(result)

# Example 2: With sample splitting
result <- rsv_estimate(
   Y = Y, D = D, S_e = S_e, S_o = S_o, R = R,
   method = "split",
   ml_params = list(train_ratio = 0.5, seed = 42),
   se_params = list(fix_seed = TRUE, clusters = clusters),
   cores = 7
)
print(result)

# Example 3: With cross fitting
result <- rsv_estimate(
  Y = Y, D = D, S_e = S_e, S_o = S_o, R = R,
  method = "crossfit",
  ml_params = list(nfold = 5, seed = 42),
  se_params = list(fix_seed = TRUE, clusters = clusters), 
  cores = 7
)
print(result)

# Example 4: Custom ML parameters
result <- rsv_estimate(
  Y = Y,
  D = D,
  S_e = S_e,
  S_o = S_o,
  R = R,
  eps = 1e-2,
  method = "none",
  ml_params = list(       # Customize random forest parameters:
    ntree = 100,          #   Number of trees
    classwt_Y = c(10, 1), #   Class weights for PRED_Y model
    seed = 42,            #   A random seed for each RF for reproducibility
  ),
  se = TRUE,
  se_params = list(       # Customize cluster-bootstrap standard errors:
    B = 1000,             #   Number of bootstrap replications
    clusters = clusters,  #   Cluster identifiers for clustered sampling
    fix_seed = TRUE,      #   Enables deterministic seeding for reproducibility 
  ),
  cores = 7
)
print(result)

# Example 5: User provides fitted predictions
data("pred_real_Ycons", package = "remoteoutcome")

result <- rsv_estimate(
  Y = pred_real_Ycons$Y,
  D = pred_real_Ycons$D,
  S_e = pred_real_Ycons$S_e,
  S_o = pred_real_Ycons$S_o,
  pred_Y = pred_real_Ycons$pred_Y,
  pred_D = pred_real_Ycons$pred_D,
  pred_S_e = pred_real_Ycons$pred_S_e,
  pred_S_o = pred_real_Ycons$pred_S_o,
  method = "predictions",
  theta_init = attr(pred_real_Ycons, "theta_init"),
  # ml_params = list(
  #   train_ratio = 0.2,    #   If theta_init is not provided, 20\% of the data
  #                         #     will be used to estimate theta_init. 
  #   seed = 42             #   A random seed for each RF for reproducibility
  # ),
  se = TRUE,
  se_params = list(B = 1000, fix_seed = TRUE, clusters = pred_real_Ycons$clusters),
  cores = 7
)
print(result)
}
}
