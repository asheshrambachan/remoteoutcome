---
title: "Poverty Application: Estimating Treatment Effects with Remotely Sensed Variables"
author: "Rambachan, Singh, and Viviano (2025)"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Poverty Application: Estimating Treatment Effects with Remotely Sensed Variables}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

# Introduction

This vignette demonstrates how to use the **remoteoutcome** package to estimate treatment effects when outcomes are measured using remotely sensed variables (RSVs). We replicate the poverty application from Rambachan, Singh, and Viviano (2025), which analyzes data from a randomized evaluation of an anti-poverty program in Andhra Pradesh, India (Muralidharan et al., 2017).

**Key Features:**
- Estimating treatment effects when outcomes are only observed in observational samples
- Comparing different sample definitions (real vs. synthetic)
- Using satellite imagery features (PCA of nighttime lights and Mosaiks features) as remotely sensed variables
- Computing cluster-robust standard errors via bootstrap

# Data Overview

## Load the Data

The dataset combines:
- **Outcome variables**: Poverty measures (consumption, low income, mid income)
- **Treatment variable**: Program assignment in experimental villages
- **Remotely sensed variable**: First principal component of satellite imagery features
- **Sample indicators**: Experimental design information

```{r load-data}
library(remoteoutcome)
library(dplyr)
library(ggplot2)

# Load poverty data (included in package)
data_path <- system.file("extdata", "poverty_pca.csv", package = "remoteoutcome")
poverty_data <- read.csv(data_path)

# Preview the data
head(poverty_data)
```

## Understanding the Variables

```{r var-summary}
# Outcome variables (binary indicators of poverty)
cat("Outcome Variables:\n")
cat("  Ycons: Consumption below 25th percentile\n")
cat("  Ylowinc: No household members earning 5k+ per month\n")
cat("  Ymidinc: No household members earning 10k+ per month\n\n")

# Treatment assignment (wave)
cat("Experimental Design:\n")
table(poverty_data$wave)
```

The experimental design has four types of villages:
- **Treatment**: Received the anti-poverty program (D = 1)
- **Control**: Pure control villages (D = 0)
- **Buffer**: Additional control villages near treated areas (D = 0)
- **Holdout**: Observational sample, no randomization (D = NA)

## Data Dimensions

```{r dimensions}
cat(sprintf("Total observations: %d\n", nrow(poverty_data)))
cat(sprintf("Number of clusters (subdistricts): %d\n",
            length(unique(poverty_data$clusters))))
cat(sprintf("Villages with treatment assignment: %d\n",
            sum(!is.na(poverty_data$D))))
cat(sprintf("Holdout villages: %d\n",
            sum(poverty_data$wave == "Holdout")))
```

# RSV Estimation with Real Sample Definition

## Step 1: Define Sample Indicators (Real Definition)

In the real sample definition from the study:
- **Experimental sample (S_e)**: All villages with treatment assignment (Treatment, Control, Buffer)
- **Observational sample (S_o)**: Holdout villages + Buffer villages

This creates an overlap where Buffer villages are in both samples.

```{r real-sample-def}
poverty_real <- poverty_data %>%
  mutate(
    # Sample indicators
    S_e = wave %in% c("Treatment", "Control", "Buffer"),  # Experimental sample
    S_o = wave %in% c("Holdout", "Buffer"),               # Observational sample

    # Sample indicator for rsv_estimate (categorical)
    S = case_when(
      wave == "Treatment" ~ "e",      # Experimental only
      wave == "Control" ~ "e",        # Experimental only
      wave == "Buffer" ~ "both",      # Both samples
      wave == "Holdout" ~ "o"         # Observational only
    ),

    # Outcomes observed only in observational sample
    Ycons_obs = ifelse(S_o, Ycons, NA),
    Ylowinc_obs = ifelse(S_o, Ylowinc, NA),
    Ymidinc_obs = ifelse(S_o, Ymidinc, NA)
  )

# Verify sample structure
table(poverty_real$S, useNA = "always")
```

## Step 2: Estimate Treatment Effects

We estimate treatment effects for each poverty outcome using the `rsv_estimate()` function with:
- **R**: First principal component of satellite features (R_PC1)
- **method = "none"**: Use all data for both training and testing (no sample splitting)
- **se = TRUE**: Compute bootstrap standard errors with cluster resampling
- **B = 500**: Number of bootstrap replications (reduced for speed)

```{r rsv-real-ycons, message=FALSE}
# Consumption poverty
rsv_real_Ycons <- rsv_estimate(
  Y = poverty_real$Ycons_obs,
  D = poverty_real$D,
  S = poverty_real$S,
  R = poverty_real$R_PC1,
  method = "none",
  se = TRUE,
  clusters = poverty_real$clusters,
  B = 500,
  alpha = 0.05,
  seed = 42
)

print(rsv_real_Ycons)
```

```{r rsv-real-other, message=FALSE}
# Low income poverty
rsv_real_Ylowinc <- rsv_estimate(
  Y = poverty_real$Ylowinc_obs,
  D = poverty_real$D,
  S = poverty_real$S,
  R = poverty_real$R_PC1,
  method = "none",
  se = TRUE,
  clusters = poverty_real$clusters,
  B = 500,
  alpha = 0.05,
  seed = 42
)

# Mid income poverty
rsv_real_Ymidinc <- rsv_estimate(
  Y = poverty_real$Ymidinc_obs,
  D = poverty_real$D,
  S = poverty_real$S,
  R = poverty_real$R_PC1,
  method = "none",
  se = TRUE,
  clusters = poverty_real$clusters,
  B = 500,
  alpha = 0.05,
  seed = 42
)
```

# RSV Estimation with Synthetic Sample Definition

## Step 1: Define Sample Indicators (Synthetic Definition)

In the synthetic sample definition:
- **Experimental sample (S_e)**: All villages with treatment assignment (same as before)
- **Observational sample (S_o)**: Random 50% of clusters (subdistricts)

This creates a different overlap pattern for methodological comparison.

```{r synth-sample-def}
# Randomly assign half the clusters to observational sample
set.seed(123)
all_clusters <- unique(poverty_data$clusters)
obs_clusters <- sample(all_clusters, size = floor(length(all_clusters) / 2))

poverty_synth <- poverty_data %>%
  mutate(
    # Sample indicators
    S_e = !is.na(D),                          # Experimental sample (has D)
    S_o = clusters %in% obs_clusters,         # Synthetic observational sample

    # Sample indicator for rsv_estimate (categorical)
    S = case_when(
      S_e & S_o ~ "both",    # Both samples
      S_e & !S_o ~ "e",      # Experimental only
      !S_e & S_o ~ "o"       # Observational only (shouldn't occur here)
    ),

    # Outcomes observed only in observational sample
    Ycons_obs = ifelse(S_o, Ycons, NA),
    Ylowinc_obs = ifelse(S_o, Ylowinc, NA),
    Ymidinc_obs = ifelse(S_o, Ymidinc, NA)
  )

# Verify sample structure
table(poverty_synth$S, useNA = "always")
```

## Step 2: Estimate Treatment Effects

```{r rsv-synth, message=FALSE}
# Consumption poverty
rsv_synth_Ycons <- rsv_estimate(
  Y = poverty_synth$Ycons_obs,
  D = poverty_synth$D,
  S = poverty_synth$S,
  R = poverty_synth$R_PC1,
  method = "none",
  se = TRUE,
  clusters = poverty_synth$clusters,
  B = 500,
  alpha = 0.05,
  seed = 42
)

# Low income poverty
rsv_synth_Ylowinc <- rsv_estimate(
  Y = poverty_synth$Ylowinc_obs,
  D = poverty_synth$D,
  S = poverty_synth$S,
  R = poverty_synth$R_PC1,
  method = "none",
  se = TRUE,
  clusters = poverty_synth$clusters,
  B = 500,
  alpha = 0.05,
  seed = 42
)

# Mid income poverty
rsv_synth_Ymidinc <- rsv_estimate(
  Y = poverty_synth$Ymidinc_obs,
  D = poverty_synth$D,
  S = poverty_synth$S,
  R = poverty_synth$R_PC1,
  method = "none",
  se = TRUE,
  clusters = poverty_synth$clusters,
  B = 500,
  alpha = 0.05,
  seed = 42
)
```

# Benchmark Estimation

For comparison, we estimate the treatment effect using only the experimental sample (traditional approach). This uses villages where both treatment and outcomes are observed.

```{r benchmark, message=FALSE}
library(fixest)

# Filter to experimental sample with observed outcomes
exp_data <- poverty_data %>%
  filter(!is.na(D))

# Benchmark regression with cluster-robust SEs
benchmark_Ycons <- feols(Ycons ~ D, data = exp_data, cluster = ~clusters)
benchmark_Ylowinc <- feols(Ylowinc ~ D, data = exp_data, cluster = ~clusters)
benchmark_Ymidinc <- feols(Ymidinc ~ D, data = exp_data, cluster = ~clusters)

# Extract results
extract_benchmark <- function(model) {
  coef_val <- coef(model)["D"]
  se_val <- model$se["D"]
  ci <- confint(model, level = 0.95)["D", ]

  data.frame(
    coef = coef_val,
    se = se_val,
    lci = ci[1],
    uci = ci[2]
  )
}

bm_Ycons <- extract_benchmark(benchmark_Ycons)
bm_Ylowinc <- extract_benchmark(benchmark_Ylowinc)
bm_Ymidinc <- extract_benchmark(benchmark_Ymidinc)
```

# Results Summary

## Compile All Results

```{r compile-results}
# Helper function to extract RSV results
extract_rsv <- function(rsv_obj) {
  data.frame(
    coef = rsv_obj$coef,
    se = rsv_obj$se,
    lci = rsv_obj$ci_lower,
    uci = rsv_obj$ci_upper
  )
}

# Consumption poverty
results_Ycons <- rbind(
  data.frame(estimator = "Benchmark", extract_benchmark(benchmark_Ycons)),
  data.frame(estimator = "RSV: Synthetic samples", extract_rsv(rsv_synth_Ycons)),
  data.frame(estimator = "RSV: Real samples", extract_rsv(rsv_real_Ycons))
)

# Low income poverty
results_Ylowinc <- rbind(
  data.frame(estimator = "Benchmark", extract_benchmark(benchmark_Ylowinc)),
  data.frame(estimator = "RSV: Synthetic samples", extract_rsv(rsv_synth_Ylowinc)),
  data.frame(estimator = "RSV: Real samples", extract_rsv(rsv_real_Ylowinc))
)

# Mid income poverty
results_Ymidinc <- rbind(
  data.frame(estimator = "Benchmark", extract_benchmark(benchmark_Ymidinc)),
  data.frame(estimator = "RSV: Synthetic samples", extract_rsv(rsv_synth_Ymidinc)),
  data.frame(estimator = "RSV: Real samples", extract_rsv(rsv_real_Ymidinc))
)
```

## Treatment Effect Estimates Table

```{r results-table}
# Consumption poverty
cat("=== Consumption Poverty (Ycons) ===\n")
print(results_Ycons, digits = 4, row.names = FALSE)
cat("\n")

# Low income poverty
cat("=== Low Income Poverty (Ylowinc) ===\n")
print(results_Ylowinc, digits = 4, row.names = FALSE)
cat("\n")

# Mid income poverty
cat("=== Mid Income Poverty (Ymidinc) ===\n")
print(results_Ymidinc, digits = 4, row.names = FALSE)
```

# Visualization

## Treatment Effect Plots

We create forest plots showing treatment effect estimates with 95% confidence intervals for all three approaches.

```{r plot-function}
# Plot function
plot_treatment_effects <- function(results, outcome_label) {
  results$estimator <- factor(results$estimator,
                             levels = c("Benchmark",
                                       "RSV: Synthetic samples",
                                       "RSV: Real samples"))

  ggplot(results, aes(x = estimator, y = coef, color = estimator, shape = estimator)) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
    geom_errorbar(aes(ymin = lci, ymax = uci), width = 0.3, linewidth = 0.7) +
    geom_point(size = 3) +
    scale_color_manual(
      values = c("Benchmark" = "black",
                "RSV: Synthetic samples" = "#3182bd",
                "RSV: Real samples" = "#08519c")
    ) +
    scale_shape_manual(
      values = c("Benchmark" = 17,
                "RSV: Synthetic samples" = 15,
                "RSV: Real samples" = 19)
    ) +
    labs(
      title = paste("Treatment Effects:", outcome_label),
      x = "",
      y = expression(paste("Treatment effect ", theta)),
      color = NULL,
      shape = NULL
    ) +
    theme_minimal() +
    theme(
      legend.position = "bottom",
      axis.text.x = element_text(angle = 15, hjust = 1),
      panel.grid.major.x = element_blank(),
      panel.grid.minor = element_blank(),
      plot.title = element_text(face = "bold", hjust = 0.5)
    )
}
```

```{r plot-ycons, fig.width=7, fig.height=5}
plot_treatment_effects(results_Ycons, "Consumption Poverty")
```

```{r plot-ylowinc, fig.width=7, fig.height=5}
plot_treatment_effects(results_Ylowinc, "Low Income Poverty")
```

```{r plot-ymidinc, fig.width=7, fig.height=5}
plot_treatment_effects(results_Ymidinc, "Mid Income Poverty")
```

# Interpretation

## Key Findings

1. **Negative Treatment Effects**: All three estimators find negative treatment effects across all poverty outcomes, indicating the program reduced poverty.

2. **RSV vs Benchmark**: The RSV estimators generally produce:
   - Similar directional findings to the benchmark
   - Different magnitudes due to leveraging observational data
   - The real sample definition (matching the study design) provides the most credible estimates

3. **Sample Definition Matters**:
   - Real sample definition uses the actual experimental design (Holdout + Buffer villages)
   - Synthetic sample definition is for methodological comparison
   - Results vary depending on sample definition, highlighting the importance of careful sample construction

## Advantages of RSV Approach

1. **Increased Precision**: By leveraging observational samples, RSV can improve efficiency
2. **External Validity**: Can estimate effects for broader populations beyond experimental samples
3. **Robustness**: Provides valid inference without requiring accurate point predictions from ML models

# Technical Details

## Sample Overlap Structure

```{r sample-overlap}
# Real sample definition
cat("=== Real Sample Definition ===\n")
cat("Experimental sample (S_e): Treatment + Control + Buffer\n")
cat("Observational sample (S_o): Holdout + Buffer\n")
cat("Overlap: Buffer villages are in BOTH samples\n\n")

with(poverty_real, table(S_e, S_o))
cat("\n")

# Synthetic sample definition
cat("=== Synthetic Sample Definition ===\n")
cat("Experimental sample (S_e): All villages with treatment\n")
cat("Observational sample (S_o): Random 50% of clusters\n")
cat("Overlap: Random 50% of experimental clusters\n\n")

with(poverty_synth, table(S_e, S_o))
```

## Bootstrap Inference

Standard errors are computed via cluster bootstrap:
- Resample clusters (subdistricts) with replacement
- Re-estimate treatment effect on bootstrap sample
- Standard error = standard deviation of bootstrap estimates
- Confidence interval = quantiles of bootstrap distribution

```{r bootstrap-info}
cat(sprintf("Bootstrap replications: %d\n", rsv_real_Ycons$call$B))
cat(sprintf("Number of clusters: %d\n", length(unique(poverty_real$clusters))))
cat(sprintf("Clustering level: Subdistrict (mandal)\n"))
```

# Conclusion

This vignette demonstrated how to use the **remoteoutcome** package to estimate treatment effects when outcomes are measured via remotely sensed variables. Key steps included:

1. Defining sample indicators based on experimental design
2. Using `rsv_estimate()` with satellite imagery features as R
3. Computing cluster-robust standard errors via bootstrap
4. Comparing RSV estimates with traditional benchmark approaches

The RSV approach provides a powerful framework for program evaluation when outcomes are costly to measure directly but can be proxied using remotely sensed data like satellite imagery.

# References

Muralidharan, K., Niehaus, P., and Sukhtankar, S. (2017). "General Equilibrium Effects of (Improving) Public Employment Programs: Experimental Evidence from India." *NBER Working Paper 23838*.

Rambachan, A., Singh, R., and Viviano, D. (2025). "Program Evaluation with Remotely Sensed Outcomes." *arXiv:2411.10959*.

# Session Info

```{r session-info}
sessionInfo()
```
